<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudSnap - Short URL Host</title>
    <style>
        :root {
            --primary: #8b5cf6; /* Violet */
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --border: #e2e8f0;
            --radius: 12px;
        }

        [data-theme="dark"] {
            --bg: #0f172a;
            --surface: #1e293b;
            --text: #f8fafc;
            --border: #334155;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }

        body {
            background-color: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: 0.3s;
        }

        .container { width: 100%; max-width: 800px; padding: 20px; }
        .hidden { display: none !important; }

        /* Login Card */
        .auth-box {
            margin-top: 10vh;
            background: var(--surface);
            padding: 2rem;
            border-radius: var(--radius);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            text-align: center;
            border: 1px solid var(--border);
        }

        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text);
            font-size: 1rem;
            outline: none;
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius);
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            font-size: 1rem;
        }
        button:hover { opacity: 0.9; transform: scale(0.98); }
        button:disabled { background: var(--border); cursor: not-allowed; }

        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-danger { background: #ef4444; color: white; }

        /* Upload Area */
        .upload-zone {
            border: 2px dashed var(--border);
            padding: 40px;
            text-align: center;
            border-radius: var(--radius);
            background: var(--surface);
            margin-bottom: 2rem;
            cursor: pointer;
            position: relative;
        }
        .upload-zone:hover { border-color: var(--primary); background: rgba(139, 92, 246, 0.05); }
        
        /* Gallery */
        .gallery-item {
            display: flex;
            align-items: center;
            background: var(--surface);
            padding: 10px;
            border-radius: var(--radius);
            margin-bottom: 10px;
            border: 1px solid var(--border);
            gap: 15px;
        }

        .thumb {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            background: #000;
        }

        .info { flex: 1; overflow: hidden; }
        .short-url {
            color: var(--primary);
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
            margin-top: 5px;
            font-family: monospace;
        }

        .actions { display: flex; gap: 5px; }
        .actions button { padding: 8px 12px; font-size: 0.8rem; }

        /* Toast */
        #toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #10b981; color: white; padding: 10px 20px; border-radius: 50px;
            opacity: 0; pointer-events: none; transition: 0.3s; z-index: 999;
        }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }

        /* Loading Spinner */
        .loader {
            display: inline-block;
            width: 20px; height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            display: none;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="toast">Copied!</div>

    <div id="login-view" class="container">
        <div class="auth-box">
            <h1>CloudSnap</h1>
            <p style="color: #64748b; margin-bottom: 20px;">Secure Image Hosting</p>
            <form onsubmit="login(event)">
                <input type="number" id="code-input" placeholder="Enter User Code (e.g. 555)" required>
                <button type="submit">Enter Vault</button>
            </form>
        </div>
    </div>

    <div id="dash-view" class="container hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <h2 id="user-title">My Gallery</h2>
            <button class="btn-outline" onclick="logout()">Logout</button>
        </div>

        <div class="upload-zone" id="drop-zone" onclick="document.getElementById('file-in').click()">
            <h3 id="upload-text">Click to Upload Image</h3>
            <p style="font-size: 0.8rem; color: #64748b;">Generates a short Imgur URL</p>
            <div id="upload-spinner" class="loader"></div>
            <input type="file" id="file-in" hidden accept="image/*" onchange="handleUpload(this.files[0])">
        </div>

        <div id="gallery-list"></div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const DB_NAME = 'CloudSnapDB';
        const CLIENT_ID = '28eea8cee256f0c'; // Public Demo ID. For serious use, get your own from api.imgur.com
        let db;
        let userCode = null;

        // --- 2. DATABASE INIT ---
        const initDB = () => new Promise((resolve) => {
            const req = indexedDB.open(DB_NAME, 1);
            req.onupgradeneeded = e => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains('links')) {
                    db.createObjectStore('links', { keyPath: 'id', autoIncrement: true })
                      .createIndex('user', 'user', { unique: false });
                }
            };
            req.onsuccess = e => { db = e.target.result; resolve(); };
        });

        // --- 3. AUTHENTICATION ---
        async function login(e) {
            e.preventDefault();
            userCode = document.getElementById('code-input').value;
            if(!userCode) return;
            
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('dash-view').classList.remove('hidden');
            document.getElementById('user-title').textContent = `Vault #${userCode}`;
            loadGallery();
        }

        function logout() {
            location.reload();
        }

        // --- 4. UPLOAD TO IMGUR API ---
        async function handleUpload(file) {
            if (!file) return;

            // UI: Show loading
            const text = document.getElementById('upload-text');
            const spinner = document.getElementById('upload-spinner');
            text.innerText = "Uploading to Cloud...";
            spinner.style.display = "inline-block";

            try {
                const formData = new FormData();
                formData.append('image', file);

                // Send to Imgur
                const response = await fetch('https://api.imgur.com/3/image', {
                    method: 'POST',
                    headers: { Authorization: `Client-ID ${CLIENT_ID}` },
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    // Success: Save the SHORT URL to our local DB
                    saveToDB(data.data.link, data.data.deletehash);
                    showToast("Uploaded successfully!");
                } else {
                    alert("Upload failed: " + (data.data.error || "Unknown error"));
                }

            } catch (err) {
                alert("Network error. Check internet.");
            } finally {
                // UI: Reset
                text.innerText = "Click to Upload Image";
                spinner.style.display = "none";
            }
        }

        // --- 5. DATABASE OPERATIONS ---
        function saveToDB(url, deleteHash) {
            const tx = db.transaction(['links'], 'readwrite');
            tx.objectStore('links').add({
                user: userCode,
                url: url,
                deleteHash: deleteHash, // Needed to delete from Imgur later if we wanted
                date: new Date()
            });
            tx.oncomplete = loadGallery;
        }

        function loadGallery() {
            const list = document.getElementById('gallery-list');
            list.innerHTML = '';

            const tx = db.transaction(['links'], 'readonly');
            const store = tx.objectStore('links');
            const index = store.index('user');
            const req = index.getAll(userCode);

            req.onsuccess = () => {
                const items = req.result.reverse(); // Newest first
                
                if(items.length === 0) {
                    list.innerHTML = '<p style="text-align:center; color:#94a3b8">No images yet.</p>';
                    return;
                }

                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'gallery-item';
                    div.innerHTML = `
                        <img src="${item.url}" class="thumb">
                        <div class="info">
                            <strong>Hosted Image</strong>
                            <a href="${item.url}" target="_blank" class="short-url">${item.url}</a>
                        </div>
                        <div class="actions">
                            <button onclick="copyLink('${item.url}')">Copy</button>
                            <button class="btn-danger" onclick="deleteLocal(${item.id})">Del</button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            };
        }

        function deleteLocal(id) {
            if(!confirm("Remove from history?")) return;
            const tx = db.transaction(['links'], 'readwrite');
            tx.objectStore('links').delete(id);
            tx.oncomplete = loadGallery;
        }

        // --- 6. UTILS ---
        function copyLink(text) {
            navigator.clipboard.writeText(text).then(() => showToast("Short URL Copied!"));
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // Start
        window.onload = initDB;

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudSnap - Folders & Compress</title>
    <style>
        :root {
            --primary: #4f46e5;
            --bg: #f8fafc;
            --surface: #ffffff;
            --sidebar: #f1f5f9;
            --text: #0f172a;
            --border: #e2e8f0;
            --radius: 12px;
            --success: #10b981;
        }

        [data-theme="dark"] {
            --bg: #0f172a;
            --surface: #1e293b;
            --sidebar: #111827;
            --text: #f8fafc;
            --border: #334155;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }

        body {
            background-color: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden; /* App-like feel */
            display: flex;
            flex-direction: column;
        }

        /* UTILS */
        .hidden { display: none !important; }
        button { cursor: pointer; border: none; border-radius: 8px; font-weight: 600; transition: 0.2s; }
        input { padding: 10px; border: 2px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); outline: none; }
        
        /* LOGIN SCREEN */
        #view-login {
            display: flex; justify-content: center; align-items: center; height: 100vh; width: 100%;
            position: absolute; top: 0; left: 0; z-index: 50; background: var(--bg);
        }
        .login-card {
            background: var(--surface); padding: 40px; border-radius: var(--radius);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center;
        }

        /* MAIN APP LAYOUT */
        #app-layout { display: flex; height: 100vh; width: 100%; }
        
        /* SIDEBAR (FOLDERS) */
        aside {
            width: 260px; background: var(--sidebar); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; padding: 20px;
        }
        .brand { font-size: 1.2rem; font-weight: bold; margin-bottom: 20px; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        
        .folder-list { flex: 1; overflow-y: auto; list-style: none; margin-top: 10px; }
        .folder-item {
            padding: 10px 12px; margin-bottom: 5px; border-radius: 8px; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center; color: var(--text);
            font-size: 0.95rem;
        }
        .folder-item:hover { background: rgba(0,0,0,0.05); }
        .folder-item.active { background: var(--primary); color: white; }
        
        .folder-count { font-size: 0.75rem; opacity: 0.7; }

        /* MAIN CONTENT */
        main { flex: 1; padding: 30px; overflow-y: auto; position: relative; display: flex; flex-direction: column; }

        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header-title h2 { font-size: 1.5rem; }
        .header-title p { color: #64748b; font-size: 0.9rem; }

        /* UPLOAD ZONE */
        .upload-zone {
            border: 2px dashed var(--border); padding: 30px; text-align: center;
            border-radius: var(--radius); background: var(--surface); cursor: pointer;
            margin-bottom: 20px; transition: 0.2s;
        }
        .upload-zone:hover { border-color: var(--primary); background: rgba(79, 70, 229, 0.05); }

        /* GALLERY GRID */
        .gallery-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px;
        }
        .img-card {
            background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
            overflow: hidden; transition: 0.2s; position: relative;
        }
        .img-card:hover { transform: translateY(-3px); shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        .img-thumb { height: 140px; width: 100%; object-fit: cover; background: #eee; }
        .img-meta { padding: 10px; }
        .img-name { font-size: 0.8rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .img-size { font-size: 0.7rem; color: #64748b; margin-top: 2px; }
        
        .card-actions {
            display: flex; gap: 5px; margin-top: 8px;
        }
        .btn-mini { flex: 1; padding: 5px; font-size: 0.75rem; border: 1px solid var(--border); background: var(--bg); color: var(--text); }
        .btn-mini:hover { background: var(--surface); }

        /* MODALS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center; z-index: 100;
        }
        .modal-box { background: var(--surface); padding: 25px; border-radius: var(--radius); width: 90%; max-width: 400px; }

        /* PROGRESS */
        .progress-container { margin-top: 10px; display: none; }
        .progress-bar { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: var(--primary); transition: width 0.2s; }

        /* TOAST */
        #toast {
            position: fixed; bottom: 30px; right: 30px; background: var(--success); color: white;
            padding: 12px 24px; border-radius: 50px; opacity: 0; transition: 0.3s; pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="toast">Notification</div>

    <div id="modal-api" class="modal-overlay hidden">
        <div class="modal-box">
            <h3>‚öôÔ∏è Initial Setup</h3>
            <p style="font-size:0.9rem; color:#64748b; margin:10px 0;">Paste your Free API Key from <b>api.imgbb.com</b></p>
            <input type="text" id="api-key-in" style="width:100%" placeholder="Paste Key Here...">
            <div style="margin-top:15px; display:flex; gap:10px;">
                <button style="flex:1; background:var(--primary); color:white; padding:10px;" onclick="saveApi()">Save & Start</button>
            </div>
        </div>
    </div>

    <div id="modal-folder" class="modal-overlay hidden">
        <div class="modal-box">
            <h3>üìÅ New Folder</h3>
            <input type="text" id="folder-name-in" style="width:100%; margin:15px 0;" placeholder="Folder Name (e.g. Vacation)">
            <div style="display:flex; gap:10px;">
                <button style="flex:1; background:var(--bg); border:1px solid var(--border); color:var(--text);" onclick="closeFolderModal()">Cancel</button>
                <button style="flex:1; background:var(--primary); color:white;" onclick="createFolder()">Create</button>
            </div>
        </div>
    </div>

    <div id="view-login">
        <div class="login-card">
            <h1>CloudSnap Pro</h1>
            <p style="color:#64748b; margin-bottom:20px;">Folders ‚Ä¢ Compression ‚Ä¢ Lifetime</p>
            <form onsubmit="login(event)">
                <input type="number" id="user-code" placeholder="User Code (e.g. 101)" required style="width:100%; margin-bottom:15px;">
                <button style="width:100%; background:var(--primary); color:white; padding:12px;">Enter Vault</button>
            </form>
        </div>
    </div>

    <div id="app-layout" class="hidden">
        <aside>
            <div class="brand">‚òÅÔ∏è CloudSnap</div>
            <button onclick="openFolderModal()" style="background:var(--primary); color:white; padding:10px; width:100%;">+ New Folder</button>
            
            <ul class="folder-list" id="folder-list-ui">
                </ul>

            <button onclick="logout()" style="margin-top:auto; background:none; border:1px solid var(--border); color:var(--text); padding:8px;">Logout</button>
        </aside>

        <main>
            <header>
                <div class="header-title">
                    <h2 id="current-folder-title">All Photos</h2>
                    <p id="current-folder-stats">0 items</p>
                </div>
                <button onclick="document.getElementById('modal-api').classList.remove('hidden')" style="background:none; color:#64748b;">‚öôÔ∏è API</button>
            </header>

            <div class="upload-zone" id="drop-zone" onclick="document.getElementById('file-in').click()">
                <h3>Upload to this Folder</h3>
                <p style="color:#64748b; font-size:0.85rem;">Drag & Drop Unlimited ‚Ä¢ Auto-Compress to KB</p>
                
                <div class="progress-container" id="prog-box">
                    <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:5px;">
                        <span id="prog-action">Compressing...</span>
                        <span id="prog-percent">0%</span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" id="prog-fill"></div></div>
                </div>
            </div>
            
            <input type="file" id="file-in" hidden multiple accept="image/*" onchange="processQueue(this.files)">

            <div class="gallery-grid" id="gallery-ui">
                </div>
        </main>
    </div>

    <script>
        /* --- 1. SYSTEM CONFIG --- */
        const DB_NAME = 'CloudSnap_Pro_v4';
        let db;
        let userCode = null;
        let apiKey = localStorage.getItem('cs_key') || '';
        let currentFolderId = 'root'; // 'root' is default

        /* --- 2. INIT & DB --- */
        window.onload = () => {
            initDB();
            if(!apiKey) document.getElementById('modal-api').classList.remove('hidden');
        };

        function initDB() {
            const req = indexedDB.open(DB_NAME, 2); // Version 2
            
            req.onupgradeneeded = e => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains('images')) {
                    db.createObjectStore('images', { keyPath: 'id', autoIncrement: true })
                      .createIndex('user', 'user', { unique: false });
                }
                if (!db.objectStoreNames.contains('folders')) {
                    db.createObjectStore('folders', { keyPath: 'id', autoIncrement: true })
                      .createIndex('user', 'user', { unique: false });
                }
            };

            req.onsuccess = e => { db = e.target.result; };
        }

        /* --- 3. AUTH & API --- */
        function login(e) {
            e.preventDefault();
            userCode = document.getElementById('user-code').value;
            if(!userCode) return;
            if(!apiKey) return alert("Please configure API key first");

            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('app-layout').classList.remove('hidden');
            loadFolders();
            loadGallery();
        }

        function logout() { location.reload(); }

        function saveApi() {
            const val = document.getElementById('api-key-in').value.trim();
            if(!val) return;
            apiKey = val;
            localStorage.setItem('cs_key', val);
            document.getElementById('modal-api').classList.add('hidden');
        }

        /* --- 4. FOLDER SYSTEM --- */
        function openFolderModal() { document.getElementById('modal-folder').classList.remove('hidden'); }
        function closeFolderModal() { document.getElementById('modal-folder').classList.add('hidden'); }

        function createFolder() {
            const name = document.getElementById('folder-name-in').value.trim();
            if(!name) return;

            const tx = db.transaction(['folders'], 'readwrite');
            tx.objectStore('folders').add({ user: userCode, name: name, date: new Date() });
            tx.oncomplete = () => {
                closeFolderModal();
                loadFolders();
                showToast("Folder Created");
            };
        }

        function loadFolders() {
            const list = document.getElementById('folder-list-ui');
            list.innerHTML = `<li class="folder-item ${currentFolderId === 'root' ? 'active' : ''}" onclick="switchFolder('root')">All Photos</li>`;

            const tx = db.transaction(['folders'], 'readonly');
            const store = tx.objectStore('folders');
            const idx = store.index('user');
            const req = idx.getAll(userCode);

            req.onsuccess = () => {
                req.result.forEach(f => {
                    const isActive = currentFolderId === f.id ? 'active' : '';
                    list.innerHTML += `
                        <li class="folder-item ${isActive}" onclick="switchFolder(${f.id})">
                            <span>üìÅ ${f.name}</span>
                        </li>`;
                });
            };
        }

        function switchFolder(id) {
            currentFolderId = id;
            loadFolders(); // refresh active state
            loadGallery();
            
            // Update Title
            if(id === 'root') {
                document.getElementById('current-folder-title').textContent = "All Photos";
            } else {
                const tx = db.transaction(['folders'], 'readonly');
                const req = tx.objectStore('folders').get(id);
                req.onsuccess = () => {
                    if(req.result) document.getElementById('current-folder-title').textContent = req.result.name;
                };
            }
        }

        /* --- 5. COMPRESSION ENGINE (The Magic) --- */
        function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        // Maintain original resolution
                        canvas.width = img.width;
                        canvas.height = img.height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);

                        // Convert to WebP at 0.8 quality (Huge size savings, invisible visual loss)
                        canvas.toBlob((blob) => {
                            resolve({
                                blob: blob,
                                originalSize: file.size,
                                newSize: blob.size,
                                name: file.name.replace(/\.[^/.]+$/, "") + ".webp"
                            });
                        }, 'image/webp', 0.8);
                    };
                };
            });
        }

        /* --- 6. UPLOAD QUEUE (Sequential + Compressed) --- */
        async function processQueue(fileList) {
            if(!fileList.length) return;

            // 1. Sort files by name (Order Guarantee)
            const files = Array.from(fileList).sort((a,b) => a.name.localeCompare(b.name, undefined, {numeric:true}));

            const uiBox = document.getElementById('prog-box');
            const uiFill = document.getElementById('prog-fill');
            const uiText = document.getElementById('prog-action');
            uiBox.style.display = 'block';

            for(let i=0; i<files.length; i++) {
                const file = files[i];
                uiText.textContent = `Processing ${i+1}/${files.length}: ${file.name}`;
                uiFill.style.width = `${((i)/files.length)*100}%`;

                try {
                    // Step A: Compress
                    uiText.textContent = `Compressing ${file.name}...`;
                    const compressed = await compressImage(file);
                    
                    // Step B: Upload
                    uiText.textContent = `Uploading ${file.name}...`;
                    await uploadToCloud(compressed);

                } catch(err) {
                    console.error("Skipped " + file.name);
                }
            }

            uiFill.style.width = '100%';
            uiText.textContent = "Done!";
            setTimeout(() => { uiBox.style.display = 'none'; loadGallery(); }, 1500);
        }

        function uploadToCloud(compObj) {
            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('image', compObj.blob, compObj.name);

                fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, {
                    method: 'POST',
                    body: formData
                })
                .then(r => r.json())
                .then(data => {
                    if(data.success) {
                        // Save to DB
                        const tx = db.transaction(['images'], 'readwrite');
                        tx.objectStore('images').add({
                            user: userCode,
                            folderId: currentFolderId,
                            url: data.data.url,
                            thumb: data.data.thumb.url,
                            name: compObj.name,
                            origSize: compObj.originalSize,
                            newSize: compObj.newSize,
                            date: new Date()
                        });
                        tx.oncomplete = resolve;
                    } else reject();
                })
                .catch(reject);
            });
        }

        /* --- 7. GALLERY RENDER --- */
        function loadGallery() {
            const grid = document.getElementById('gallery-ui');
            grid.innerHTML = '';

            const tx = db.transaction(['images'], 'readonly');
            const idx = tx.objectStore('images').index('user');
            const req = idx.getAll(userCode);

            req.onsuccess = () => {
                let items = req.result;
                
                // Filter by folder if not root
                if(currentFolderId !== 'root') {
                    items = items.filter(i => i.folderId === currentFolderId);
                }

                // Sort newest last (append order) or newest first
                items.sort((a,b) => b.id - a.id);

                document.getElementById('current-folder-stats').textContent = `${items.length} items`;

                if(!items.length) {
                    grid.innerHTML = `<p style="grid-column:1/-1; text-align:center; color:#94a3b8; margin-top:50px;">Folder Empty</p>`;
                    return;
                }

                items.forEach(img => {
                    const savings = Math.round((1 - (img.newSize / img.origSize)) * 100);
                    const sizeStr = (img.newSize/1024).toFixed(1) + ' KB';
                    
                    grid.innerHTML += `
                        <div class="img-card">
                            <img src="${img.thumb}" class="img-thumb" loading="lazy">
                            <div class="img-meta">
                                <div class="img-name" title="${img.name}">${img.name}</div>
                                <div class="img-size">‚¨á ${savings}% saved (${sizeStr})</div>
                                <div class="card-actions">
                                    <button class="btn-mini" onclick="copyLink('${img.url}')">Copy</button>
                                    <button class="btn-mini" style="color:red" onclick="deleteImg(${img.id})">Del</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            };
        }

        function deleteImg(id) {
            if(!confirm("Delete from history?")) return;
            const tx = db.transaction(['images'], 'readwrite');
            tx.objectStore('images').delete(id);
            tx.oncomplete = loadGallery;
        }

        /* --- UTILS --- */
        function copyLink(url) {
            navigator.clipboard.writeText(url);
            showToast("Link Copied!");
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 2000);
        }

        // Drag & Drop
        const dz = document.getElementById('drop-zone');
        dz.ondragover = e => { e.preventDefault(); dz.style.borderColor = 'var(--primary)'; };
        dz.ondragleave = e => { e.preventDefault(); dz.style.borderColor = 'var(--border)'; };
        dz.ondrop = e => { e.preventDefault(); processQueue(e.dataTransfer.files); };

    </script>
</body>
</html>
